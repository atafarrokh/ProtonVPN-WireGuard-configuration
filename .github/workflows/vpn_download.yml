name: ðŸŒ ProtonVPN Config Downloader & Telegram Uploader

on:
  # Allows manual triggering of the workflow
  workflow_dispatch:

jobs:
  download-and-upload:
    # Use a runner that supports installing custom software
    runs-on: ubuntu-latest
    
    # Define environment variables linked to GitHub Secrets
    env:
      VPN_USERNAME: ${{ secrets.VPN_USERNAME }}
      VPN_PASSWORD: ${{ secrets.VPN_PASSWORD }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # âš™ï¸ Install necessary system packages (Firefox, Python, zip)
      - name: âš™ï¸ Install Browser, Python, and Tools
        run: |
          # 1. Update system and install Firefox, Python tools, and zip
          sudo apt-get update -y
          sudo apt-get install -y firefox python3 python3-pip zip 
          
          # 2. Install Python dependencies
          pip3 install selenium
          
          # 3. Download and Install GeckoDriver
          # Download a specific version for compatibility
          GECKODRIVER_VERSION="v0.34.0" 
          wget -q https://github.com/mozilla/geckodriver/releases/download/$GECKODRIVER_VERSION/geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz
          tar -xzf geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz
          
          # Move GeckoDriver to a standard binary location in PATH and set execution permissions
          sudo mv geckodriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/geckodriver
          
          # Verify the installation path of Firefox (optional check)
          if [ ! -f /usr/bin/firefox ]; then
            echo "::error::Firefox executable not found at /usr/bin/firefox"
            exit 1
          fi

      # ðŸš€ Execute the Python script. Files are saved in downloaded_configs/.
      - name: ðŸƒ Execute ProtonVPN Downloader
        run: python3 proton_downloader.py

      # --- Steps for Telegram Upload ---
      
      - name: ðŸ—œï¸ Compress Downloaded Files
        # Zip the entire downloaded_configs folder
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ZIP_FILENAME="configs_${TIMESTAMP}.zip"
          
          # Check if the directory exists and is not empty before zipping
          if [ -d "downloaded_configs" ] && [ "$(ls -A downloaded_configs)" ]; then
            zip -r "$ZIP_FILENAME" downloaded_configs/
            echo "ZIP_FILE=$ZIP_FILENAME" >> $GITHUB_ENV
          else
            echo "::warning::Download directory is empty or not found. Skipping Telegram upload."
            echo "ZIP_FILE=NOT_FOUND" >> $GITHUB_ENV
          fi

      - name: ðŸ“¬ Send Configs to Telegram Channel
        # Skip this step if no files were found (ZIP_FILE=NOT_FOUND)
        if: env.ZIP_FILE != 'NOT_FOUND'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_CHAT_ID }}
          token: ${{ env.TELEGRAM_BOT_TOKEN }}
          document: ${{ env.ZIP_FILE }} # Send the dynamically named zip file
          caption: |
            âœ… ProtonVPN Configs Downloaded Successfully!
            Generated by GitHub Action
            Actor: ${{ github.actor }}
          
      - name: âœ… Clean up
        # Remove temporary files and directories, always run this step
        if: always()
        run: rm -rf downloaded_configs *.zip
